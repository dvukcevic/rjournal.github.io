# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit RJ-2023-026.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width="100%")
library(ggplot2)
#library(kableExtra)


## ----Fig0, fig.height = 12, fig.width=8, fig.cap = "The visual predictive check plot. The solid red line represents the $50^{th}$ percentile of the observed data, and dashed red lines represent the $10^{th}$ and $90^{th}$ percentiles of the observed data. The solid blue line represents the $50^{th}$ percentile of the simularted data, and dashed blue lines represent the $10^{th}$ and $90^{th}$ percentiles of the simulated data. Light blue and pink areas represent the 95\\% confidence areas of the $10^{th}$, $50^{th}$ and $90^{th}$ percentile lines."----
library(nlmeVPC)
library(ggplot2)
library(gridExtra)
data(origdata)
data(simdata)

A=VPCgraph(origdata,simdata,N_xbin=8,type="scatter")+
  labs(title="(A) Visual Predictive Check : scatter",caption="")
B=VPCgraph(origdata,simdata,N_xbin=8,type="percentile")+
  labs(title="(B) Visual Predictive Check : percentile",caption="")
C=VPCgraph(origdata,simdata,N_xbin=8,type="CI")+
  labs(title="(C) Visual Predictive Check : CI",caption="")
grid.arrange(A,B,C,nrow=3)


## ----Fig1, fig.height = 4, fig.width=8, fig.cap = "The additive equantile VPC plot.  Dots indicate the observed data. The solid and dashed blue lines represent the $10^{th}$, $50^{th}$, and $90^{th}$ percentiles of the simulated data. The solid red line represents the $50^{th}$ percentile line. Light blue and pink areas represent the 95\\% confidence areas of the $10^{th}$, $50^{th}$ and $90^{th}$ percentile lines."----
aqrVPC(origdata,simdata) +labs(caption="")


## ----Fig2, fig.height = 4, fig.width=8, fig.cap = "The bootstrap VPC plot. Dots indicate the observed data. The solid and dashed blue lines represent the $10^{th}$, $50^{th}$, and $90^{th}$ percentiles of the simulated data. The solid red line represents the $50^{th}$ percentile line, and the pink areas represent the 95\\% confidence areas of the $50^{th}$ percentile line, calculated from the bootstrap samples of the observed data."----
bootVPC(origdata,simdata,N_xbin=8)


## ----Fig3, fig.height = 8, fig.width=8,fig.cap = "The average shifted VPC plot. Dots indicate the observed data. The solid line represents the 50th quantiles of the observed data, and dashed lines represent the $10^{th}$ and $90^{th}$ percentiles of the observed data. Light blue and pink areas represent the 95\\% confidence areas of the $10^{th}$, $50^{th}$, and $90^{th}$ percentiles."----
A=asVPC(origdata,simdata,type="CI",N_xbin=8,N_hist=3,weight_method="bin") +labs(caption="")
B=asVPC(origdata,simdata,type="CI",N_xbin=8,N_hist=3,weight_method="distance")+labs(caption="")
grid.arrange(A,B,nrow=2)


## ----echo=TRUE----------------------------------------------------------------
NumericalCheck(origdata,simdata,pred.level=c(0,0.2,0.4,0.6,0.8,0.9),N_xbin=8)$NPC


## ----Fig4, out.width="90%", fig.height = 10, fig.width=6, fig.cap = "The coverage plot and the coverage detailed plot for the 80\\% prediction interval. In the coverage plot, the X-axis is the level of the prediction interval. The Y-axis is the ratio between the number of observed data and the number of expected data of the lower and upper parts in each level of the prediction interval. The white line is the reference line, and the gray area represents the confidence area of the ratios. If the solid lines are near the white line, we can conclude that the suggested model is suitable. In the coverage detailed plot, the white dots represent the expected percentages of lower and upper prediction intervals of, 10\\%, and 90\\%, respectively. The upper and lower percentages of observation in each time bin are darker gray."----

A=coverageplot(origdata,simdata,N_xbin=8) +ggtitle("(A) Coverage Plot")
B=coverageDetailplot(origdata,simdata,N_xbin=8,predL=0.8) +
ggtitle("(B) Coverage detailed plot: PI = 80")
grid.arrange(A,B,nrow=2)


## ----Fig5, fig.height = 5, fig.width=6,fig.cap = "The quantified VPC plot. The darker gray areas represent the percentages below the median, the lighter gray areas represent the percentage above, and the brightest gray areas represent the percent unavailable in each time bin. The white dots represent the ideal location where the above and the below percentages meet."----

quantVPC(origdata,simdata)


## ----table1, eval = knitr::is_html_output()-----------------------------------
#> AA=data.frame(Function = c("VPCgraph","aqrVPC","bootVPC","asVPC","NujmericalCheck","coverageplot","coverageDetailplot","quantVPC"),
#>            Description = c("draw the original VPC plot",
#> "draw the additive quantile regression VPC plot",
#> "draw the bootstrap VPC plot",
#> "draw VPC using ASH method",
#> "calculate the numbers to check coverage in each prediction level",
#> "plot the result of NumericalCheck",
#> "plot for checking specific prediction level",
#> "plot for the quantified VPC"))
#> 
#> knitr::kable(AA, format = "html", caption = "List of functions to check the validity of model with the observed data and the simulated data")


## ----table2, eval = knitr::is_html_output()-----------------------------------
#> BB=data.frame(
#>   Argument =c("orig_data","sim_data","type","weight_method","N_xbin",
#> "probs","conf.level","X_name","Y_name","subject_name","MissingDV",
#> "DV_point","CIvpc_type","bin_grid","plot_caption","plot_flag","linesize",
#> "pointsize","captionsize","maxK","Kmethod","beta","lambda"),
#> Description=c(
#> "A data frame of original data with X and Y variable",
#> "A matrix of simulated data with only Y values collected",
#> "Type of VPC graph; 'CI', 'percentile', or 'scatter'",
#> "The way to put weights in `asVPC`; 'bin' or 'distance'",
#> "Number of bins in X variable",
#> "A numeric vector of probabilities",
#> "Confidence level of the interval",
#> "Name of X variable in`orig_data`",
#> "Name of Y variable in `orig_data`",
#> "Name of subject variable in `orig_data`",
#> "Name of missing indicator variable in `orig_data`",
#> "Draw point (X, Y) in the plot if TRUE; omit if FALSE",
#> "Type of CI area in VPC graph; 'line' or 'segment'",
#> "Draw grid lines for binning in X variable if TRUE; omit if FALSE",
#> "Put caption with additional information if TRUE; omit if FALSE",
#> "Draw plot if TRUE; generate data for drawing plot if FALSE",
#> "Size of line in the plot",
#> "Size of point in the plot",
#> "Size of caption",
#> "The maximum number of bins",
#> "The way to calculate the penalty in automatic binning; 'cluster' or 'kernel'",
#> "Additional parameter for automatic binning, used in `optK` function",
#>  "Additional parameter for automatic binning, used in `optK` function"))
#> 
#> 
#> knitr::kable(BB, format = "html", caption = "Summary of the arguments of functions in nlmeVPC")


## ----echo=TRUE----------------------------------------------------------------
library(nlmeVPC)
data(origdata)
data(simdata)

optK(origdata$TIME)$K


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> # Figure 1
#> 
#> VPCgraph(origdata,simdata,N_xbin=8,type="scatter")+
#>   labs(title="(A) Visual Predictive Check : scatter",caption="")
#> VPCgraph(origdata,simdata,N_xbin=8,type="percentile")+
#>   labs(title="(B) Visual Predictive Check : percentile",caption="")
#> VPCgraph(origdata,simdata,N_xbin=8,type="CI")+
#>   labs(title="(C) Visual Predictive Check : CI",caption="")
#> 
#> # Figure 2
#> 
#> aqrVPC(origdata,simdata) +labs(caption="")
#> 
#> # Figure 3
#> 
#> bootVPC(origdata,simdata,N_xbin=8)+labs(caption="")
#> 
#> # Figure 4
#> 
#> asVPC(origdata,simdata,type="CI",N_xbin=8,N_hist=3,weight_method="bin")+labs(caption="")
#> asVPC(origdata,simdata,type="CI",N_xbin=8,N_hist=3,weight_method="distance")+labs(caption="")
#> 
#> # Numerical Predictive Check
#> 
#> NumericalCheck(origdata,simdata,N_xbin=8,pred.level=c(0,0.2,0.4,0.6,0.8,0.9))$NPC
#> 
#> # Figure 5
#> 
#> 
#> coverageplot(origdata,simdata,N_xbin=8) +ggtitle("(A) Coverage Plot")
#> coverageDetailplot(origdata,simdata,N_xbin=8,predL=0.8) +
#> ggtitle("(B) Coverage Detailed plot: PI = 80")
#> 
#> # Figure 6
#> 
#> quantVPC(origdata,simdata)


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> library(nlme)
#> library(nlraa)
#> library(nlmeVPC)
#> data(origdata)
#> origdataT <- groupedData(DV~TIME|ID,origdata)
#> 
#> # Model 1 (True)
#> T.nlme <- nlme(DV ~ exp(lKe+lKa-lCl)*AMT*
#>                (exp(-exp(lKe)*TIME) - exp(-exp(lKa)*TIME))/
#>                (exp(lKa)-exp(lKe)), data=origdataT,
#>              fixed=lKa+lKe+lCl~1,
#>              random=lKa+lCl~1,
#>              start=c(lKe=-2,lKa=1.5,lCl=-3))
#> set.seed(123456)
#> sim.T <- simulate_nlme(object=T.nlme,nsim=100,psim=3,level=1,value="data.frame",data = NULL)
#> simdata.T <- matrix(sim.T$sim.y,ncol=100)
#> 
#> # Model 2 (Wrong)
#> F.nlme <- nlme(DV ~ exp(lKe+lKa-lCl)*AMT*
#>                 (exp(-exp(lKe)*TIME) - exp(-exp(lKa)*TIME))/
#>                 (exp(lKa)-exp(lKe)), data=origdataT,
#>               fixed=lKa+lKe+lCl~1,
#>               random=lKe~1,
#>               start=c(lKe=-2,lKa=1.5,lCl=-3))
#> 
#> sim.F <- simulate_nlme(object=F.nlme,nsim=100,psim=3,level=1,value="data.frame",data = NULL)
#> simdata.F <- matrix(sim.F$sim.y,ncol=100)


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> 
#> # Figure 7
#> 
#> VPCgraph(origdata,simdata.T,type="CI",N_xbin=8)+labs(title="Model 1",caption="")
#> VPCgraph(origdata,simdata.F,type="CI",N_xbin=8)+labs(title="Model 2",caption="")
#> 
#> # Figure 8
#> 
#> aqrVPC(origdata,simdata.T)+labs(title="Model 1",caption="")
#> aqrVPC(origdata,simdata.F)+labs(title="Model 2",caption="")
#> 
#> # Figure 9
#> 
#> asVPC(origdata,simdata.T,type="CI",weight_method="distance",N_xbin=8)+labs(title="Model 1",caption="")
#> asVPC(origdata,simdata.F,type="CI",weight_method="distance",N_xbin=8)+labs(title="Model 2",caption="")
#> 
#> # Figure 10
#> 
#> bootVPC(origdata,simdata.T,N_xbin=8)+labs(title="Model 1",caption="")
#> bootVPC(origdata,simdata.F,N_xbin=8)+labs(title="Model 2",caption="")
#> 
#> # Figure 11
#> 
#> coverageplot(origdata,simdata.T,conf.level=0.9,N_xbin=8)+labs(title="Model 1")
#> coverageplot(origdata,simdata.F,conf.level=0.9,N_xbin=8)+labs(title="Model 2")
#> 
#> # Figure 12
#> 
#> coverageDetailplot(origdata,simdata.T,predL=0.5,N_xbin=8)+labs(title="Model 1")
#> coverageDetailplot(origdata,simdata.F,predL=0.5,N_xbin=8)+labs(title="Model 2")
#> 
#> # Figure 13
#> 
#> coverageDetailplot(origdata,simdata.T,predL=0.8,N_xbin=8)+labs(title="Model 1")
#> coverageDetailplot(origdata,simdata.F,predL=0.8,N_xbin=8)+labs(title="Model 2")
#> 
#> # Figure 14
#> 
#> quantVPC(origdata,simdata.T,N_xbin=8)+labs(title="Model 1")
#> quantVPC(origdata,simdata.F,N_xbin=8)+labs(title="Model 2")
#> 


## ----M11,fig.height = 3, fig.width=7.5,fig.cap = "The VPC plots of Model 1 and Model 2."----
simdata.T=readRDS("./data/simdataT.rda")
simdata.F=readRDS("./data/simdataF.rda")
A=VPCgraph(origdata,simdata.T,type="CI",N_xbin=8)+labs(title="Model 1",caption="")
B=VPCgraph(origdata,simdata.F,type="CI",N_xbin=8)+labs(title="Model 2",caption="")
grid.arrange(A,B,ncol=2)


## ----M12, fig.height = 3, fig.width=7.5,fig.cap = "The additive quantile regression VPC plots for Model 1 and Model 2."----
A=aqrVPC(origdata,simdata.T)+labs(title="Model 1",caption="")
B=aqrVPC(origdata,simdata.F)+labs(title="Model 2",caption="")
grid.arrange(A,B,ncol=2)


## ----M13, fig.height = 3, fig.width=7.5,fig.cap = "The average shifted VPC plots for Model 1 and Model 2."----
A=asVPC(origdata,simdata.T,type="CI",weight_method="distance",N_xbin=8)+labs(title="Model 1",caption="")
B=asVPC(origdata,simdata.F,type="CI",weight_method="distance",N_xbin=8)+labs(title="Model 2",caption="")
grid.arrange(A,B,ncol=2)


## ----M14, fig.height = 3, fig.width=7.5,fig.cap = "The bootstrap VPC plots for Model 1 and Model 2."----
A=bootVPC(origdata,simdata.T,N_xbin=8)+labs(title="Model 1",caption="")
B=bootVPC(origdata,simdata.F,N_xbin=8)+labs(title="Model 2",caption="")
grid.arrange(A,B,ncol=2)


## ----M15, fig.height = 3, fig.width=7.5,fig.cap = "The coverage plots for Model 1 and Model 2."----
A=coverageplot(origdata,simdata.T,conf.level=0.9,N_xbin=8)+labs(title="Model 1")
B=coverageplot(origdata,simdata.F,conf.level=0.9,N_xbin=8)+labs(title="Model 2")
grid.arrange(A,B,ncol=2)


## ----M16,fig.height = 3, fig.width=7.5,fig.cap = "The coverage detailed plots for Model 1 and Model 2 when PI=50\\%."----
A=coverageDetailplot(origdata,simdata.T,predL=0.5,N_xbin=8)+labs(title="Model 1")
B=coverageDetailplot(origdata,simdata.F,predL=0.5,N_xbin=8)+labs(title="Model 2")
grid.arrange(A,B,ncol=2)


## ----M17, fig.height = 3, fig.width=7.5,fig.cap = "The coverage detailed plots for Model 1 and Model 2 when PI=80\\%."----
A=coverageDetailplot(origdata,simdata.T,predL=0.8,N_xbin=8)+labs(title="Model 1")
B=coverageDetailplot(origdata,simdata.F,predL=0.8,N_xbin=8)+labs(title="Model 2")
grid.arrange(A,B,ncol=2)


## ----M18, fig.height = 3, fig.width=7.5,fig.cap = "The quantified VPC plots for Model 1 and Model 2."----
A=quantVPC(origdata,simdata.T,N_xbin=8)+labs(title="Model 1")
B=quantVPC(origdata,simdata.F,N_xbin=8)+labs(title="Model 2")
grid.arrange(A,B,ncol=2)

