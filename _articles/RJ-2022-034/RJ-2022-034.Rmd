---
title: 'iccCounts: An R Package to Estimate the Intraclass Correlation Coefficient
  for Assessing Agreement with Count Data'
abstract: |
  The intraclass correlation coefficient (ICC) is a widely used index to assess agreement with continuous data. The common approach for estimating the ICC involves estimating the variance components of a linear mixed model under assumptions such as linearity and normality of effects. However, if the outcomes are counts these assumptions are not met and the ICC estimates are biased and inefficient. In this situation, it is necessary to use alternative approaches that are better suited for count data. Here, the iccCounts R package is introduced for estimating the ICC under the Poisson, Negative Binomial, Zero-Inflated Poisson and Zero-Inflated Negative Binomial distributions. The utility of the iccCounts package is illustrated by three examples that involve the assessment of repeatability and concordance with count data.
draft: no
author:
- name: Josep L. Carrasco
  affiliation: University of Barcelona
  address:
  - Biostatistics. Department of Basic Clinical Practice
  - Casanova 143, 08036, Barcelona, Spain
  url: https://webgrec.ub.edu/webpages/personal/ang/005037_jlcarrasco.ub.edu.html
  orcid: 0000-0003-1184-0753
  email: jlcarrasco@ub.edu
type: package
header-includes: \usepackage{longtable}
output:
  rjtools::rjournal_article:
    self_contained: yes
    toc: no
bibliography: carrasco.bib
date: '2022-10-19'
date_received: '2021-10-11'
volume: 14
issue: 2
slug: RJ-2022-034
journal:
  lastpage: 243
  firstpage: 229

---









```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)
library(gridExtra)

```

# Introduction

Repeated measurements are often collected and hierarchically structured in clusters (commonly, in subjects). These repeated measurements can be interchangeable within subjects (i.e. they are replicates). This case is often known as the evaluation of repeatability [@nakagawa2010] or intra-rater reliability [@DeVet2011]. Moreover, the repeated measurements may be structured (not interchangeable) because they were obtained under different experimental conditions, involving different methods or observers. In this case the analysis of agreement is often known as concordance analysis, method comparison analysis [@Choudhary2017] or inter-rater reliability [@DeVet2011]. 

Whatever the structure of the repeated measurements, the intraclass correlation coefficient (ICC) is a common index used to assess agreement with continuous data [@fleiss1986; @carrasco2003]. The general definition of the ICC is the ratio of the between-clusters variance to the total variance. However, the appropriate ICC has to be defined to afford the different variance components that are involved in the total variance besides the between-clusters variance. These variance components are typically estimated by means of a linear mixed model with common assumptions: that there is linearity between the outcome expectation and the effects (cluster, method,...); and that the random effects and the random error follow normal distributions. Currently, there are several R packages that estimate the ICC under the Normality assumption for assessing repeatability or concordance  [@Wolak2012;@carrasco2013;@Stoffel2017].

However, if the outcomes are counts, such assumptions are not met and the ICC estimates are biased and inefficient [@carrasco2005]. In this situation, it is necessary to use alternative approaches that are better suited to the properties of count data. The methodology for estimating the ICC for non-normal distributions using generalized linear mixed models (GLMM), and in particular for count data, was developed in @carrasco2010. The ICC is therefore estimated by the variance components from the appropriate GLMM. The cluster random effect is still distributed as a Normal distribution but the within-cluster variability is assumed to follow a probability distribution function for counts. @Stoffel2017 introduced the \CRANpkg{rptR} package which can be used to estimate the ICC assuming a Poisson model for the within-subjects variability. 

In the \CRANpkg{iccCounts} package introduced here, besides the Poisson distribution, other models as the Negative Binomial, the Zero-Inflated Poisson and the Zero-Inflated Negative Binomial are also considered. These models are useful when overdispersion arises in the Poisson model. Overdispersion means that the variability assumed by the model is lower than that from the data. Therefore, the within-subjects variability and, by extension, the total variance are underestimated and the ICC and its standard error are biased. Thus, the validity of the ICC estimate is closely linked to the validity of the model, so that a goodness-of-fit (GOF) analysis of the model must be performed. 

The article is structured as follows: the \dfn{Methodology background} section introduces the definition of the ICC, their expressions depending on the model GLLM chosen, some inferential aspects and the validation approach of the GLMM; the issues of the package are described in \dfn{Package description} section; in \dfn{Examples} section three examples are introduced. Two of them are cases of the repeatability setting whereas the remaining one shows the case of a concordance setting. Finally, the main contributions are summarized in the \dfn{Conclusion} section. 

# Methodology background

## Experimental design

As mentioned in the introduction, the experimental design depends on the aim of the study: concordance or repeatability. In the case of a concordance study, a sample of n subjects are measured m times by k methods. In this setting, the aim is to analyse the degree of concordance of the measurement methods when assessing the subjects. Note that within-subjects repeated measurements are not interchangeable because they belong to one specific method. It is worthy to noting that the term "methods" is the conventional way to describe the experimental condition of the repeated measurements across subjects in this context, but it might be referred to differently name depending on the context. In this setting, $Y_{ijk}$ stands for the k-th reading made by the j-th method on the i-th subject, with $i=1,\ldots,n$, $j=1,\ldots,m$ and $k=1,\ldots,s$. Hence, there will be three variance components to consider when assessing agreement among the repeated measurements: between-subjects, between-methods and random error variabilities. 

In a repeatability study, a sample of n subjects are measured m times. In this case the repeated measurements share the same experimental condition across subjects, therefore they can be considered as interchangeable. Thus, in this setting $Y_{ik}$ stands for the k-th reading made on the i-th subject, with $i=1,\ldots,n$, and $k=1,\ldots,s$. In this case, only two variance components are involved in the evaluation of the agreement: between-subjects and random error variabilities.

## Generalized linear mixed model

The estimation of the variance components is carried out by means of generalized linear mixed models (GLMM). The GLMM for the concordance setting (considering subjects and methods effects) is defined as follows:

- Let $\alpha_i$ and $\beta_j$ be the subjects and methods random effects respectively, with $i=1,\ldots,n$, $j=1,\ldots,m$, that follow Normal distributions with mean 0 and variance $\sigma_{\alpha}^2$ and $\sigma_{\beta}^2$. Although the method effect could be a fixed effect by design, when defining the agreement index it is convenient to consider it as a random effect to account for the systematic differences between observers as a source of disagreement [@fleiss1986;@carrasco2003].

- The conditional distribution of $Y_{ijk}$ given $\alpha_i$ and $\beta_j$, $f\left(Y_{ijk}|\alpha_i,\beta_j\right)$,  is a probability density function from the exponential family.

- The conditional mean of $Y_{ijk}$ given $\alpha_i$ and $\beta_j$ is 


\begin{equation}
\mu_{ij}=E\left(Y_{ijk}|\alpha_i,\beta_j\right)=g^{-1}\left(\lambda_i+\alpha_i+\beta_j\right).
(\#eq:glmm)
\end{equation}
  
where $g$ is called the link function. Here, $\lambda_i$ is the linear combination of the mean modifying covariates for the i-th subject. 
Furthermore, the conditional variance of  $Y_{ijk}$ given $\alpha_i$ and $\beta_j$ is defined as $Var\left(Y_{ijk}|\alpha_i,\beta_j\right)=\phi h\left(\mu_{ij}\right)$ where $\phi$ is the dispersion parameter and $h\left(\right)$ is variance function.
  
  
  If the methods effect is removed, the GLMM for the repeatability setting is obtained.
Thus, depending on the nature of the data the appropriate conditional probability model and link function must be chosen. When analysing count data, the logarithm is commonly used as a link function and models such as Poisson or Negative Binomial are considered.


## Intraclass correlation coefficient for count data

The intraclass correlation coefficient (ICC) is calculated as:

\begin{equation}
ICC=\frac{Cov\left(Y_{ijk},Y_{ij'k'}\right)}{Var\left(Y_{ijk}\right)}.
(\#eq:icc)
\end{equation}

where the $Cov\left(Y_{ijk},Y_{ij'k'}\right)$ is the marginal (over subjects and observers) covariance between any pair of data from the same subject, whereas $Var\left(Y_{ijk}\right)$ is the marginal variance of data.  


Furthermore, the marginal variance and covariance can be developed as functions of the GLMM parameters [@carrasco2010]:

\begin{equation}
ICC=\frac{Cov\left(\mu_{ij},\mu_{ij'}\right)}{Var\left(\mu_{ij}\right)+E\left(\phi h\left(\mu_{ij}\right)\right)}
(\#eq:icc2)
\end{equation}

This result allows the ICC to be generalized to any distribution fitted with a GLMM.

@carrasco2010 developed the ICC for Poisson and Negative Binomial distributions, the latter with variance increasing quadratically with the mean (NegBin2), $Var\left(Y_{ijk}|\alpha_i,\beta_j\right)=\mu_{ij} \left(1+r\mu_{ij}\right)$ (Table \@ref(table:tableICC)). A Negative Binomial model with variance increasing linearly with the mean is also considered (NegBin1) [@brooks2017;@hardin2007],  $Var\left(Y_{ijk}|\alpha_i,\beta_j\right)=\mu_{ij} \left(1+r\right)$. It is worth to noting that NegBin1 does not belong to the exponential family [@hardin2007], therefore this model would not be a proper GLMM. However, it can still be useful to model count data that show overdispersion in a Poisson model. 

Additionally, it is possible to define the ICC for the cases of zero inflated models (Table \@ref(table:tableICC)). Let's define $B_{ijk}$ as a Bernoulli variable that takes a value of 1 if the reading $k$ on subject $i$ and method $j$ is a structural zero with  probability $\pi$ and 0 otherwise. The observed data, $X_{ijk}$ is the result of $X_{ijk}=Y_{ijk}\left(1-B_{ijk}\right)$, where $Y_{ijk}$ is the count variable as defined before. The marginal covariance and variance of $X_{ijk}$ are:

\begin{equation}
Cov\left(X_{ijk},X_{ij'k'}\right)=Cov\left(Y_{ijk},Y_{ij'k'}\right)\left(1-\pi\right)^2
(\#eq:cov)
\end{equation}

\begin{equation}
Var\left(X_{ijk}\right)=Var\left(Y_{ijk}\right)\left(1-\pi\right)+E^2\left(Y_{ijk}\right)\pi\left(1-\pi\right)
(\#eq:var)
\end{equation}

and the general expression of the ICC for zero-inflated data becomes:

\begin{equation}
ICC=\frac{Cov\left(Y_{ijk},Y_{ij'k'}\right)\left(1-\pi\right)}{Var\left(Y_{ijk}\right)+E^2\left(Y_{ijk}\right)\pi}
(\#eq:icc3)
\end{equation}

where $\pi$ stands for the probability of excess of zeros.


Notice that ICCs appearing in Table \@ref(table:tableICC) are for the concordance setting where $\sigma^2_\beta$ stands for the variability between methods. The ICCs for the repeatability setting are obtained just removing $\sigma^2_\beta$ from the equations, i.e. by setting $\sigma^2_\beta=0$.



\begin{table}[h]
\begin{center}
\begin{minipage}{14cm}
\bgroup\small
\begin{tabular}{|l|c|c||l|c|c|}
\hline
Model & ICC & $\theta$ & Model & ICC & $\theta$ \\ \hline
Poisson & $\frac{\mu\left(e^{\sigma_\alpha^2}-1\right)}{\mu\left(e^{\sigma_\alpha^2+\sigma_\beta^2}-1\right)+1}$ & $\left(\mu,\sigma_\alpha^2,\sigma_\beta^2\right)$ & ZIP & $\frac{\mu\left(e^{\sigma_\alpha^2}-1\right)\left(1-\pi\right)}{\mu\left(e^{\sigma_\alpha^2+\sigma_\beta^2}-1\right)+1+\mu\pi}$ & $\left(\mu,\sigma_\alpha^2,\sigma_\beta^2\right)$\\ \hline
NegBin1 & $\frac{\mu\left(e^{\sigma_\alpha^2}-1\right)}{\mu\left(e^{\sigma_\alpha^2+\sigma_\beta^2}-1\right)+r+1}$ & $\left(\mu,\sigma_\alpha^2,\sigma_\beta^2, r\right)$ & ZI-NegBin1 & $\frac{\mu\left(e^{\sigma_\alpha^2}-1\right)\left(1-\pi\right)}{\mu\left(e^{\sigma_\alpha^2+\sigma_\beta^2}-1\right)+1+r+\mu\pi}$ & $\left(\mu,\sigma_\alpha^2,\sigma_\beta^2, r, \pi \right)$\\ \hline
NegBin2 & $\frac{\mu\left(e^{\sigma_\alpha^2}-1\right)}{\mu\left(\left(r+1\right)e^{\sigma_\alpha^2+\sigma_\beta^2}-1\right)+1}$ & $\left(\mu,\sigma_\alpha^2,\sigma_\beta^2, r \right)$ & ZI-NegBin2 & $\frac{\mu\left(e^{\sigma_\alpha^2}-1\right)\left(1-\pi\right)}{\mu\left(\left(r+1\right)e^{\sigma_\alpha^2+\sigma_\beta^2}-1\right)+1+\mu\pi}$ & $\left(\mu,\sigma_\alpha^2,\sigma_\beta^2, r, \pi \right)$ \\
\hline
\end{tabular}
\egroup
\caption{\footnotesize{ICC expressions. NegBin1 and NegBin2 are the Negative Binomial models with variance increasing linearly and quadratically  with the mean  respectively; ZI are the zero-inflated models. $\theta$ stand for parameters involved in ICC: $\mu$ stands for the marginal mean; $\sigma^2_\alpha$ is the between-subjects variance; $\sigma^2_\beta$ is the between-methods variability; $r$ is the Negative Binomial's dispersion parameter; and $\pi$ is the probability of excess of zeros.}}
\label{table:tableICC}
\end{minipage}
\end{center}
\end{table}


## Estimation of ICC

The estimation of the ICC involves estimating the GLMM parameters. However, maximum likelihood approach is not straightforward because there is no closed analytical expression for the marginal likelihood besides the Normal case (linear mixed model). Thus, it is necessary to apply numerical methods to approximate the marginal likelihood and to obtain maximum likelihood estimates [@Bolker2009]. 
With regards to the standard error of the ICC, let $\theta$ be the GLMM parameters involved in the ICC expression (see  Table \@ref(table:tableICC)) and $\Sigma$ the variance-covariance matrix of $\theta$. The asymptotic standard error can be estimated by applying the delta method [@verHoef2012]:

\begin{equation}
Var\left(ICC\right) \approx \Delta'\Sigma\Delta
(\#eq:varicc)
\end{equation}

where $\Delta$ stand for the vector containing the derivatives of ICC respect to $\theta$. Confidence intervals for the ICC are based on asymptotic Normal distribution using the inverse hyperbolic tangent function or Fisher's Z-transformation [@carrasco2003].

## Validation

The goodness-of-fit (GOF) analysis can be carried out by the computation of randomized quantile residuals (RQR) [@Dunn1996;@Feng2020]. Briefly, the GOF analysis involve the comparison of the RQR from the original data to those obtained by simulation under the fitted model. Simulations of counts based on the fitted model are generated and the model is refitted to each simulated dataset. Using the simulated RQR, envelopes are built as the appropriate quantiles (in relation to the level of significance) of RQR from the refitted models. If the model fits correctly the data it is expected that the original RQR will completely lie within the simulated envelopes.

Additionally, dispersion as well as zero-inflation can be checked by comparing the dispersion and proportion of zeros from the simulated data to those from the original data. Thus, tests for dispersion and zero inflation are carried out by comparing the RQR dispersion and the number of zeros from the original model and data to those from the refitted models and simulated data. 


# Package description

The main function in the \CRANpkg{iccCounts} package is \dfn{icc\_counts} which estimates the ICC under different models for count data. The argument \dfn{data} identifies the data set to be analysed. This data set has to be a \dfn{data.frame} object with at at least two columns: outcome and subject identifier (arguments \dfn{y} and \dfn{id} respectively). 

In the case of estimating the ICC for the concordance setting, a third column with the method identifier must be provided (the argument \dfn{met}). The argument \dfn{type} is used to identify the setting in which the ICC should be estimated. Valid values are: \dfn{rep} (default) for the repeatability setting; and \dfn{con} for the concordance setting. The repeatability setting requires that repeated measurements are interchangeable within subjects. This means the experimental conditions of the measurements are the same (replicates), and they come from the same probability distribution function (conditioned to subjects). On the other hand, in the concordance setting the repeated measurements are not interchangeable because their experimental conditions are different, and therefore their probability distribution function, conditioned to subjects, is different (commonly in the mean).

The argument \dfn{fam} is used to identify the within-subjects probability model. Valid options are: \dfn{poisson} (default) for Poisson model; \dfn{nbinom1} and \dfn{nbinom2} for Negative Binomial model with variance increasing linearly and quadratically with the mean respectively; \dfn{zip} for zero-inflated Poisson model; \dfn{zinb1} and \dfn{zinb2} for zero-inflated Negative Binomial model with variance increasing linearly and quadratically with the mean. 

Once the appropriate setting and model have been chosen, the GLMM is estimated by maximum likelihood via Laplace approximation using the \CRANpkg{glmmTMB} package [@brooks2017]. The output of the \dfn{icc\_counts} function is an object of class \dfn{iccc} which is a list with the following components: \dfn{model} which contains the generalized linear mixed model estimates; \dfn{ICC} which includes the ICC estimate and its standard error and confidence interval; and \dfn{varcomp} with the variance components and parameters related to the ICC. Finally, the function \dfn{GOF\_check} runs the goodness of fit (GOF) analysis of the GLMM fitted to data. This function has three arguments: \dfn{x} to denote the \dfn{iccc} object to apply the GOF analysis; the \dfn{nsim} argument that stands for the number of simulations to run which default value is set to 100; and the $\alpha$ argument to set the level of significance.  

The output of \dfn{GOF\_check} is an object of class \dfn{GOF} which is a list with the following components: \dfn{plot\_env}, a plot of RQR envelopes with the original RQR; \dfn{plot\_var}, a plot of the simulated RQR dispersion; \dfn{plot\_zi}, a plot of the count of zeros in the simulated datasets; \dfn{res\_var}, the dispersion of RQR from the original sample; \dfn{pval\_var}, the proportion of simulated RQR dispersion that are greater than the original dispersion that can be interpreted as a simulated P-value to check the goodness of fit on dispersion; \dfn{zero\_count}, the count of zeros in the original sample; and \dfn{pval\_zi}, the proportion of simulated zero count that are greater than that of the original sample. It can be interpreted as a simulated P-value to check the hypothesis of zero-inflation. The plots in the list are objects of class \dfn{ggplot}, hence users may change the plot themes or add modifications to the components.

Additionally, to describe the differences among the repeated measurements from the same subjects, the function \dfn{plot\_BA} draws the Bland-Altman plot [@bland1995]. The difference between each pair of data from the same subject is represented on the y-axis. The mean of data from the same subject is represented on the x-axis. Additionally, a bar plot with the proportions of differences can be drawn. This plot is a useful way to describe the differences when the range of observed values is small relative to the number of observations [@Smith2010].

The arguments of \dfn{plot\_BA} function are: \dfn{data},  a data frame containing at least the columns of the outcome and subject's identifier; \dfn{y}, a character string indicating the name of the outcome column in the data set; \dfn{id} a character string indicating the name of the subjects column in the data set; \dfn{rm}, a character string indicating the name of the column that stands for the repeated measurements in the data set. This argument is only needed to identify the differences; \dfn{type}, argument used to choose the plot to be drawn. Valid values are: \dfn{BA} (default) for the Bland-Altman plot; and \dfn{bars} for the bar plot of the differences. Besides the plots, the function provides a dataframe object that contains the data used to generate the plot.

# Examples


The package includes three real data sets as examples that covers the repeatability and concordance settings. 

## Sparrow fledglings paternity example

In the Sparrow fledglings paternity example, the incidence of extra-pair paternity (EPP) was monitored over 3 breeding seasons in a sparrow colony in Lundy, an island off the southwest coast of England [@Schroeder2012]. One of the aims of the study was to assess the repeatability of counts of fledglings that a male had in every breeding season. Thus, the repeated measurements are assumed to be exchangeable replicates. However, the means of the Social variable by year seem to differ:

```{r}
library(iccCounts)
library(dplyr)
EPP %>% group_by(Year) %>% summarize(Mean=mean(Social),SD=sd(Social))
```


In case these means were significantly different the repeated measurements could not be considered as exchangeable, and consequently the differences among the means of the repeated measurements should be included in the agreement index. This led us to the concordance setting considering Year as the methods effect.

The first model to consider is the Poisson model. The default option in the \dfn{icc\_counts} function is the Poisson model, and so it is necessary to specify the name of the data set, the count variable (Social), the subjects identifier (id), the methods variable (Year), and the concordance setting (type="con"). 

```{r}
EPP_P<-icc_counts(EPP,y="Social",id="id",met="Year",type="con")
ICC(EPP_P)
VarComp(EPP_P)
```

The function \dfn{ICC} applied to the \dfn{iccc} object shows that the ICC estimate is 0.53 (95\% confidence interval: 0.34 - 0.68). Moreover, the function \dfn{VarComp} gives the parameters involved in the ICC estimator, which in this case are the overall mean, the between-subjects variance and the between-methods variability (the two latter in log-scale). 

However, as mentioned in the previous section, the validity of the ICC estimate is linked to the validity of the model. The function \dfn{GOF\_check} is applied to the \dfn{iccc} object to run the simulations and to compute the RQR. The random seed is set for the sake of the reproducibility of the example. 

```{r}
set.seed(100)
EPP_P.gof <- GOF_check(EPP_P)
```

```{r, eval = FALSE}
plot(EPP_P.gof)
```


Figure \@ref(fig:figure1)a shows the plot of RQR with envelopes generated by simulation. Points on the plot stand for the RQR from the original sample. Notice that a substantial number of points lie outside the envelopes, indicating the fit of the model is unsuitable. The next plot (Figure \@ref(fig:figure1)c) shows the density of the RQR variances computed in the simulated samples. The RQR variance from the initial sample is 2.15 (shown inside the square) which is extreme compared to those from the simulations. Indeed, the proportion of simulated variances that are higher than that from the initial sample can be interpreted as a p-value generated by Monte Carlo simulation. This p-value is shown by applying the function \dfn{DispersionTest} to the \dfn{GOF} object. 

```{r}
DispersionTest(EPP_P.gof)
```

Additionally, the Social variable has a considerable proportion of zero values ($26.4\%$), and so the excess of zeros could be the cause of the unsuitable fitting of the Poisson model. To check this hypothesis, the third plot generated shows the proportion of zeros in the simulated data sets (Figure \@ref(fig:figure1)e). The count of zeros in the sample is 51, which exceeds the expected count under the Poisson model. Again, the proportion of simulated zero counts that are higher than that from the initial sample can be interpreted as a p-value generated by Monte Carlo simulation. This p-value is obtained by applying the function \dfn{ZeroTest} to the \dfn{GOF} object.

```{r}
ZeroTest(EPP_P.gof)
```

Thus, it is necessary to use a model able to provide a proportion of zeros higher than that expected under the Poisson assumption. This model could be the Zero-Inflated Poisson (ZIP) model. 

```{r}
EPP_ZIP<-icc_counts(EPP,y="Social",id="id",met="Year",type="con",fam="zip")
ICC(EPP_ZIP)
VarComp(EPP_ZIP)
```

In this case, the ICC is much lower than in the Poisson model (0.05, 95\% CI: -0.02, 0.12) indicating a non-significant ICC. The ICC components are the same as those in the Poisson case (with different values) plus the proportion of excess of zeros (0.24). Next step is to check whether the model correctly fits the data. 

```{r}
set.seed(100)
EPP_ZIP.gof <- GOF_check(EPP_ZIP)
```

```{r, eval = FALSE}
plot(EPP_ZIP.gof)
```

```{r figure1, echo=F, fig.width = 6, fig.height = 9, fig.cap="Goodness of fit for Sparrow fledglings paternity example. The Randomized Quantile Residuals (RQR) and counts of zeros of original data are compared to those from simulated data under the fitted model. The plots shown are RQR with envelopes, dispersion of RQR and count of zeros. Left column shows results for Poisson model while the plots for Zero Inflated Poisson (ZIP) model are on right column."}


p1<-plot(EPP_P.gof,type="envelope")+ 
  labs(caption="a) RQR envelopes plot. Poisson Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))
p1$layers[[1]]$aes_params$shape<-NULL
p1$layers[[1]]$aes_params$size<-0.75

p2<-plot(EPP_ZIP.gof,type="envelope")+ 
  labs(caption="b) RQR envelopes plot. ZIP Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))
p2$layers[[1]]$aes_params$shape<-NULL
p2$layers[[1]]$aes_params$size<-0.75

p3<-plot(EPP_P.gof,type="dispersion")+ 
  labs(caption="c) Dispersion plot. Poisson Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p4<-plot(EPP_ZIP.gof,type="dispersion")+ 
  labs(caption="d) Dispersion plot. ZIP Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p5<-plot(EPP_P.gof,type="zeros")+ 
  labs(caption="e) Proportion of zeros plot. Poisson Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p6<-plot(EPP_ZIP.gof,type="zeros")+ 
  labs(caption="f) Proportion of zeros plot. ZIP Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

grid.arrange(p1,p2,p3,p4,p5,p6,nrow=3)
```


Figure \@ref(fig:figure1)b shows the model to be appropriate because all the RQR are within the envelopes. Additionally, the dispersion and the proportion of zeros from the initial sample are within the values expected under the ZIP model (Figures \@ref(fig:figure1)d and \@ref(fig:figure1)f). This fact can be also verified by verifying that dispersion and excess of zeros tests are non significant.

```{r}
DispersionTest(EPP_ZIP.gof)
ZeroTest(EPP_ZIP.gof)
```

Thus, the ZIP model fits the data appropriately. The next step is to check if the differences in means between years are significant and the concordance setting is therefore justified. With this aim let us apply the function \dfn{icc\_counts} to the ZIP model but in the repeatability setting.

```{r}
EPP_ZIP_0<-icc_counts(EPP,y="Social",id="id",fam="zip")
```

The component \dfn{model} in the \dfn{iccc} object is an object of class \dfn{glmmTMB} that contains the generalized linear mixed model fit. The \dfn{anova} method applied to the model objects gives a comparison of deviances and a likelihood ratio test:


```{r}
anova(EPP_ZIP$model,EPP_ZIP_0$model)
```


The result of the comparison confirms a significant difference between the yearly means, and the convenience of the concordance setting.

Next, let us apply the function \dfn{plot\_BA} to generate the Bland-Altman plot and the bar plot of the differences in EPP between years. The plots are shown in  Figures \@ref(fig:figure4)a and \@ref(fig:figure4)b.

```{r, fig.show='hide'}
EPP.BA<-plot_BA(EPP,y="Social",id="id",rm="Year") # Bland-Altman plot
```

```{r, eval = FALSE}
plot_BA(EPP,y="Social",id="id",type="bars") # Bar plot
```

It can be seen that the magnitude of the differences grows as the mean increases. This heteroscedastic pattern is expected in counts because of the relation between the within-subjects variance and mean. Furthermore, we can compute some descriptive statistics of the differences:

```{r}
summary(EPP.BA$data$Diff)
quantile(EPP.BA$data$Diff,probs=c(0.05,0.95))
```

Briefly, the mean of the differences between years is 0.97 fledglings, and the median is 1 fledgling. Ninety percent of the differences are between -4 and 6 fledglings between years.

## CD34+ count cell example

The dataset \dfn{AF} includes data where a new method of flow cytometry for counting CD34+ cells is compared to the readings obtained by a standard approach (Fornas et al., 2000). Both methods (coded as 1 and 3 in the dataset) were applied to a sample of 20 subjects. The aim of the study is to assess the interchangeability between the methods so it is necessary to evaluate the degree of concordance. Hence, the ICC used here concurs with the concordance correlation coefficient estimated by variance components [@carrasco2003]. 

Let's firstly consider the Poisson model. As we are facing a concordance analysis, in the \dfn{icc\_counts} function the name of the method's variable (\dfn{met}) has to be provided along with the counts variable (\dfn{y}) and subject's identifier (\dfn{id}). Additionally, it is necessary to specify the concordance analysis in the type argument because the default is the repeatability analysis. 

```{r}
AF_P <- icc_counts(AF, y = "y", id = "id", met = "met", type = "con")
ICC(AF_P)
VarComp(AF_P)
```

The function \dfn{ICC} applied to the \dfn{iccc} object shows that the ICC estimate is 0.85 (95\% confidence interval: 0.80, 0.89). Moreover, the function \dfn{VarComp} gives the parameters involved in the ICC estimator. In this case are the overall mean (mu),  the between-subjects variance (BSVar) and the between-methods variability (BMVar) (the two last in log-scale). 

Next, let's check the validity of the model by applying the function \dfn{GOF\_check} to the \dfn{iccc} object. 

```{r}
set.seed(100)
AF_P.gof <- GOF_check(AF_P)
```

Figure \@ref(fig:figure2)a shows the plot of RQR with envelopes generated by simulation. Points on the plot stand for the RQR from the original sample. Most of points lie outside of the envelopes indicating the unsuitable fit of the model. Next plot (Figure \@ref(fig:figure2)b) shows the density of the RQR variances computed at the simulated samples. The RQR variance from the initial sample is 32.2  which is much larger than those from the simulations. The p-value to test overdispersion is obtained by applying the function \dfn{DispersionTest} to the \dfn{GOF}. With regards the zero inflation, no zeros were found in data so it is unnecessary to check this issue.

```{r}
DispersionTest(AF_P.gof)
```

Consequently, it is necessary to use a model able to afford the overdispersion as the Negative Binomial distribution. 

```{r}
AF_NB2 <- icc_counts(AF, y = "y", id = "id", met = "met", type = "con", fam = "nbinom2")
ICC(AF_NB2)
VarComp(AF_NB2)
```

In this case, the ICC is quite similar to that from the Poisson model (0.83, 95\% CI: 0.72, 0.90) but the confidence interval is wider. The ICC components are the same as those from the Poisson case (with different values) plus the Negative Binomial dispersion parameter (0.049). Concerning the fit of the model, 

```{r}
set.seed(100)
AF_NB2.gof <- GOF_check(AF_NB2)
```


```{r, eval = FALSE}
plot(AF_NB2.gof)
```



```{r figure2, echo=F, fig.width = 6, fig.height =6, fig.cap="Goodness of fit for CD34 cell count example. The Randomized Quantile Residuals (RQR) of original data are compared to those from simulated data under the fitted model. The plots shown are RQR with envelopes, and dispersion of RQR. First row shows results for Poisson model while the plots for Negative Binomial model are on second row."}


p7<-plot(AF_P.gof,type="envelope")+ 
  labs(caption="a) RQR envelopes plot. Poisson Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))
p7$layers[[1]]$aes_params$shape<-NULL
p7$layers[[1]]$aes_params$size<-0.75

p8<-plot(AF_NB2.gof,type="envelope")+ 
  labs(caption="b) RQR envelopes plot. Negative Binomial model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))
p8$layers[[1]]$aes_params$shape<-NULL
p8$layers[[1]]$aes_params$size<-0.75

p9<-plot(AF_P.gof,type="dispersion")+ 
  labs(caption="c) Dispersion plot. Poisson Model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p10<-plot(AF_NB2.gof,type="dispersion")+ 
  labs(caption="d) Dispersion plot. Negative Binomial model")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))


grid.arrange(p7,p9,p8,p10,nrow=2)
```


in Figure \@ref(fig:figure2)c all the RQR are within the envelopes indicating the appropriateness of the model. Additionally, the dispersion from the initial sample is within the expected values (Figure \@ref(fig:figure2)d). This result is also confirmed by running the dispersion test:

```{r}
DispersionTest(AF_NB2.gof)
```

Figures \@ref(fig:figure4)c and \@ref(fig:figure4)d show the Bland-Altman plot and the Bar plot of the differences between method 1 and 2 that are generated by the following commands:

```{r, fig.show='hide'}
AF.BA <- plot_BA(AF,y="y",id="id", rm="met") # Bland-Altman plot
```

```{r, eval = FALSE}
plot_BA(AF,y="y",id="id", type="bars") # Bar plot
```

It can be seen that for values of the mean below 700 the within-subjects differences are very close to 0. However, for larger values of the mean there is a trend in the differences in relation to the mean values.

## Tick counts example

In this study, the repeatability of line transects survey method to estimate tick abundance was assessed [@Pia2021] in the area of Grimso (Sweden). With this aim, sampling was performed by two parallel transects separated by 1m-2m where the total count of ticks was recorded. Here, the transects are the cluster variable and every pair of data from the same transect are considered as replicates. Data is stored in the package as the \dfn{Grimso} object.

As seen before the first model to consider is the Poisson model. As it is a repeatability analysis, in the \dfn{icc\_counts} function we just need to provide the name of the counts variable (\dfn{Tot}) and subject's identifier (\dfn{TransectID}). 

```{r}
G_P <- icc_counts(Grimso, y = "Tot", id = "TransectID")
ICC(G_P)
VarComp(G_P)
```

The function \dfn{ICC} applied to the \dfn{iccc} object shows that the ICC estimate is 0.35 (95\% confidence interval: 0.06, 0.59). The function \dfn{VarComp} gives the parameters involved in the ICC estimator: the overall mean and the between-subjects variance (the latter in log-scale). 

Let's apply the function \dfn{GOF\_check} to the \dfn{iccc} object to check the validity of the model. 

```{r}
set.seed(100)
G_P.gof <- GOF_check(G_P)
```

```{r, eval = F}
plot(G_P.gof)
```

Figure \@ref(fig:figure3)a shows the plot of RQR with envelopes generated by simulation. All points on the plot lie within the envelopes indicating the fit of the model is correct. Additionally, Figure \@ref(fig:figure3)b shows the RQR variance from the initial sample (1.84) is compatible with the dispersion observed in the simulated samples. The overdispersion test is run by applying the function \dfn{DispersionTest} to the \dfn{GOF} object. 

```{r}
DispersionTest(G_P.gof)
```


The p-value is 0.416 so the null hypothesis of no overdispersion is not rejected and no further models have to be fitted.


```{r figure3, echo=F, fig.width = 6, fig.height =3, fig.cap="Goodness of fit for Tick counts example. The Randomized Quantile Residuals (RQR) of original data are compared to those from simulated data under the fitted model. The plots shown are RQR with envelopes, and dispersion of RQR for Poisson model."}


p11<-plot(G_P.gof,type="envelope")+ 
  labs(caption="a) RQR envelopes plot. Poisson Model")+
  theme(plot.caption=element_text(size=10, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))
p11$layers[[1]]$aes_params$shape<-NULL
p11$layers[[1]]$aes_params$size<-0.75

p12<-plot(G_P.gof,type="dispersion")+ 
  labs(caption="c) Dispersion plot. Poisson Model")+
  theme(plot.caption=element_text(size=10, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))



grid.arrange(p11,p12,nrow=1)
```

The Bland-Altman plot and the Bar plot of the within-subjects differences are shown in Figures \@ref(fig:figure4)e and \@ref(fig:figure4)f.

```{r,fig.show='hide'}
G.BA <- plot_BA(Grimso,y="Tot",id="TransectID",rm="Round") # Bland-Altman plot
```

```{r, eval = F}
plot_BA(Grimso,y="Tot",id="TransectID", type="bars") # Bar plot
```

As in the case of the sparrow fledgling paternity counts, we can observe a heteroscedastic pattern with the variability of the differences increasing with the mean. Most of the differences are 0 (75\%) and 90\% of the differences lie between -1 and 1.

```{r}
quantile(G.BA$data$Diff, probs=c(0.05,0.95))
```

```{r, fig.show='hide', echo=F}
p13<-plot_BA(EPP,y="Social",id="id",rm="Year")$plot +
  labs(caption="a) Bland-Altman plot. Sparrow fledglings \n paternity example") +
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p14<-plot_BA(EPP,y="Social",id="id",type="bars")$plot + 
  labs(caption="b) Bar plot of differences. Sparrow fledglings \n paternity example")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p15 <- plot_BA(AF,y="y",id="id", rm="met")$plot + 
  labs(caption="c) Bland-Altman plot. CD34+ count cell example")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p16 <- plot_BA(AF,y="y",id="id", type="bars")$plot + 
  labs(caption="d) Bar plot of differences. CD34+ count cell example")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p17 <- plot_BA(Grimso,y="Tot",id="TransectID",rm="Round")$plot + 
  labs(caption="e) Bland-Altman plot. Tick counts example")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))

p18 <- plot_BA(Grimso,y="Tot",id="TransectID", type="bars")$plot + 
  labs(caption="f) Bar plot of differences. Tick counts example")+
  theme(plot.caption=element_text(size=8, hjust=0, margin=margin(15,0,0,0)),
        text = element_text(size = 8))
```

```{r figure4, echo=F, fig.width = 6, fig.height =9, fig.cap="Bland-Altman and Bar plots. The first column shows the Bland-Altman plots where difference between pairs of data from the same subject (Y-axis) is plotted against mean of data from the same subject (X-axis). The second column contains the Bar plots of the differences between pairs of data from the same subject. The plots for Sparrow fledglings paternity example are on the first row, the CD34+ count cell example plots are on second row, and plots for Tick counts example are on third row."}

grid.arrange(p13,p14,p15,p16,p17,p18,nrow=3)
```


# Conclusion

The statistical assessment of agreement is an issue that has received a considerable attention in recent years. It is possible to find statistical software to carry out such analysis for qualitative or continuous data (see for example @Revelle2021;@carrasco2013;@DFeng2020)
. However, there is a lack of tools when dealing with discrete data. Here, the \strong{iccCounts} package have been introduced to assess the agreement with such type of data considering both repeatability and concordance settings. Furthermore, the \strong{iccCounts} package provides the methodology to assess the validity of the model fitted to data. 

It is important to note that no factors or predictors other than subjects and methods have been considered in the linear predictor of the GLMM. When fitting a GLMM, the inclusion of further covariates allows controlling for confounding effects. In this case, the ICC computed after controlling for confounding effects is referred to as adjusted repeatability [@nakagawa2010]. Including covariates in the linear predictor make sense when the aim is to estimate the magnitude of an effect (difference in means, odds ratio or ratio of means, for instance) adjusted by the covariates. When estimating the ICC in a linear model, the inclusion of covariates will lead to a change in the variance components estimates but they remain as common estimates for all subjects. However, when facing the models for count data, the addition of covariates in the linear predictor leads to different ICCs because the value of the marginal mean $\mu$ will be different for every level of the covariates. For this reason, in the case of count data, it is preferable to segregate the data to estimate a different ICC according to the covariates. In this way, both the variance components and the mean will be different.

Furthermore, in the Normal model setting the ICC takes values from 0 to 1. A value of 0 means independence among the measures from the same cluster (no cluster effect) whilst a value of 1 implies perfect agreement, i.e. all data from the same subject are equal. However, it is not possible to reach a value of 1 in the counts setting. The reason for this is that some within-subject variability is unavoidable because of the relation between the variance and the mean in these models. Thus, it i s not possible to observe perfect agreement with count data but the interpretation remains the same: the proportion of the total variance accounted for between-subjects variability.

# Availability

The current stable version of the package requires R 4.0 and can be downloaded from CRAN [](https://cran.r-project.org/web/packages/iccCounts/). Furthermore, \dfn{iccCounts} depends on the following R packages: \CRANpkg{glmmTMB} [@brooks2017]; \CRANpkg{ggplot2} [@Wickham2016]; \CRANpkg{Deriv} [@Clausen2020];  \CRANpkg{gridExtra} [@Auguie2017]; and \CRANpkg{dplyr} [@Wickham2020].

# Acknowledgments

I would like to thank to Shinichi Nakagawa from UNSW Sydney (Australia) for kindly providing the Sparrow fledglings paternity data. I am also indebted to Pia Kjellander from Linköping University (Sweden) for sharing the Tick count data.
